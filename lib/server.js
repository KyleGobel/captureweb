/** 
* @license captureweb - v0.0.2
* (c) 2013 Julien VALERY https://github.com/darul75/starter-aws
* License: MIT 
**/
function Server(){this.renderer=require("./renderer")}var path=require("path"),paths={};paths.temp_directory=path.resolve("temp");var script=__dirname+"/script1.js";Server.prototype.start=function(a){if(a){var b=this;this.port=a,this.prepare_temp_directory(),this.server=require("http").createServer(function(a,c){return"/"==a.url&&"post"==a.method.toLowerCase()?(b.handler(a,c),void 0):(b.errors(["invalid request"],c),void 0)}),this.server.listen(this.port)}},Server.prototype.stop=function(){this.server||this.server.close()},Server.prototype.handler=function(a,b){var c=this;this.json(a,function(a,d){return a?(c.errors(a,b),void 0):(c.validate(d,function(a){return a?(c.errors(a,b),void 0):(d.handle=paths.temp_directory+"/"+c.create_handle(d.mime),c.render(d,function(a){return a?(c.errors(a,b),void 0):(require("fs").exists(d.handle,function(a){if(!a)return c.errors(["phantomjs failed to render"],b),void 0;var e=require("fs").statSync(d.handle);b.writeHead(200,{"Content-Type":d.mime,"Content-Length":e.size});var f=require("fs").createReadStream(d.handle);f.on("data",function(a){b.write(a)}),f.on("end",function(){require("fs").unlink(d.handle,function(){b.end()})})}),void 0)}),void 0)}),void 0)})},Server.prototype.render=function(a,b){this.renderer.exec(script,[a.url,a.handle,a.viewportSize],b)},Server.prototype.json=function(a,b){this.recv(a,function(a,c){if(a)return b(a,null),void 0;try{var d=JSON.parse(c);b(null,d)}catch(e){b([e.toString()],null)}})},Server.prototype.recv=function(a,b){var c=[];a.setEncoding("utf8"),a.on("data",function(a){c.push(a)}),a.on("error",function(a){b(a,null)}),a.on("end",function(){b(null,c.join(""))})},Server.prototype.create_handle=function(a){var b=".jpg";switch(a){case"application/pdf":b=".pdf";break;case"image/png":b=".png";break;case"image/jpg":b=".jpg";break;case"image/jpeg":b=".jpg";break;case"image/gif":b=".gif"}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})+b},Server.prototype.validate=function(a,b){if(!a)return b(["message is null"]),void 0;var c=[];if(a.url||a.content||c.push(["url or content is required"]),a.url&&a.content&&c.push(["cannot supply both url and content in the same request"]),a.mime||c.push(["mime is required"]),a.mime)switch(a.mime){case"application/pdf":break;case"image/jpeg":break;case"image/jpg":break;case"image/png":break;case"image/gif":break;default:c.push("output mime is invalid.")}if(a.viewportSize&&a.viewportSize.width&&a.viewportSize.height){var d=a.viewportSize.width,e=a.viewportSize.height;a.viewportSize=d+" "+e}c.length>0&&b(c),b(null)},Server.prototype.prepare_temp_directory=function(){var a=require("fs").existsSync(paths.temp_directory);if(a)for(var b=require("fs").readdirSync(paths.temp_directory),c=0;c<b.length;c++)require("fs").unlinkSync(paths.temp_directory+"/"+b[c]);else require("fs").mkdirSync(paths.temp_directory);return this},Server.prototype.errors=function(a,b){b.writeHead(500,{"Content-Type":"application/json"}),b.write(JSON.stringify(a,null,4)),b.end()};var server=new Server;module.exports=server;